version: '3.6'

# TODO: connect sample-platform with nginx and db
services:
  sample-platforn:
    build: 
      context: ./sample-platform-python
      args: 
        db_user: sample_user
        db_user_password: sample_password
        db_name: sample_platform
        config_server_name: sample_platform
        config_application_root: None
        github_token: sample_github_token
        github_owner_name: CCExtractor
        github_repository: ccextractor
        email_domain: sample_email_domain
        email_api_key: sample_email_api_key
        github_deploy_key: sample_github_deploy_key
        github_ci_key: sample_github_ci_key
        kvm_linux_name: sample_kvm_linux_name
        kvm_windows_name: sample_kvm_windows_name
        kvm_max_runtime: 120
        server_name: sample_server_name
        ftp_port: 21
        max_content_length: 536870912
        min_pwd_len: 10
        max_pwd_len: 500
        sample_repository: /repository
    restart: always

  nginx-proxy:
    image: nginxproxy/nginx-proxy
    container_name: nginx-front-facing
    restart: always
    labels:
      com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy: "true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - certs:/etc/nginx/certs:ro
      - config:/etc/nginx/conf.d
      - vhost:/etc/nginx/vhost.d
      - chall_html:/usr/share/nginx/html
      - dhparam:/etc/nginx/dhparam
    environment:
      - ENABLE_IPV6=true
      - SSL_POLICY=Mozilla-Intermediate

  nginx-proxy-letsencrypt:
    image: nginxproxy/acme-companion
    container_name: nginx-lets-encrypt
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - certs:/etc/nginx/certs:rw
      - config:/etc/nginx/conf.d
      - vhost:/etc/nginx/vhost.d
      - chall_html:/usr/share/nginx/html

  platform_db_mariadb:
    image: mariadb
    container_name: platform_db_mariadb
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: always
    volumes:
      - db:/var/lib/mysql
      - /platform/db_setup:/docker-entrypoint-initdb.d
    env_file:
      - /platform/db.env

volumes:
  certs:
  config:
  vhost:
  chall_html:
  dhparam:
  db:
